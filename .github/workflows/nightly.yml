name: Nightly Release

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  nightly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current version and date
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          DATE=$(date +'%Y%m%d')
          NIGHTLY_VERSION="${CURRENT_VERSION}-nightly.${DATE}"
          echo "nightly_version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Build package
        run: |
          # Skip i18n build for nightly (no wp-env in CI for this)
          node ./publish.js

      - name: Delete previous nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all releases with 'nightly' in the tag
          NIGHTLY_RELEASES=$(gh release list --json tagName --jq '.[] | select(.tagName | contains("nightly")) | .tagName')
          for tag in $NIGHTLY_RELEASES; do
            echo "Deleting release: $tag"
            gh release delete "$tag" --yes --cleanup-tag || true
          done

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.nightly_version }}" \
            --title "Nightly Build ${{ steps.version.outputs.date }}" \
            --notes "Automated nightly build from main branch.

          **Version:** ${{ steps.version.outputs.nightly_version }}
          **Built from:** ${{ github.sha }}

          This is a pre-release build for testing purposes." \
            --prerelease \
            *.zip
